# This sets the human-readable name of the workflow
name: CI - Build & Test

# This section defines which GitHub events will trigger this workflow
on:
  # This event triggers on every Pull Request
  pull_request:

  # This event triggers on direct pushes to branches
  push:
    # We restrict push triggers to the main branch only
    branches:
      - main

# This section defines the jobs for this workflow
jobs:
  # First job: build and type-check
  build:
    # Use an Ubuntu Linux runner
    runs-on: ubuntu-latest

    # Steps for the build job
    steps:
      # Step: checkout the repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step: setup Node.js runtime
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Use Node.js version 20
          node-version: 20

      # Step: install pnpm package manager
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          # Use pnpm version 8
          version: 8

      # Step: install project dependencies
      - name: Install dependencies
        # Run pnpm install to restore node_modules
        run: pnpm install

      # Step: run TypeScript type-check to validate the build
      - name: Type check (build validation)
        # Use tsc in noEmit mode so we only validate types
        run: pnpm tsc --noEmit

  # Second job: lint + unit tests + Playwright tests
  test:
    # This job depends on the successful completion of the build job
    needs: build
    # Use the same Ubuntu runner
    runs-on: ubuntu-latest

    # Environment variables available to all steps in this job
    env:
      # Provide a valid SESSION_SECRET for CI (at least 32 characters long)
      # This is a dummy secret used only for tests, not for real production usage
      SESSION_SECRET: ci-session-secret-1234567890-abcdef

    # Steps for the test job
    steps:
      # Step: checkout the repository again (each job starts clean)
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step: setup Node.js runtime
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # Same Node.js version for consistency
          node-version: 20

      # Step: install pnpm for this job
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          # Same pnpm version as in the build job
          version: 8

      # Step: install project dependencies needed for tests
      - name: Install dependencies
        # Run pnpm install again (cache will speed this up)
        run: pnpm install

      # Step: run ESLint to enforce code quality rules
      - name: Run ESLint (lint)
        # Uses your package.json "lint" script
        run: pnpm lint

      # Step: run TypeScript type-check as part of the CI quality gate
      - name: Run TypeScript type-check
        # Same tsc noEmit command
        run: pnpm tsc --noEmit

      # Step: run unit and contract tests with Vitest
      - name: Run unit tests
        # Uses your "test:unit" script
        run: pnpm test:unit

      # Step: run quality/meta test suite (env, lint, scripts, hooks, etc.)
      - name: Run QA meta tests
        # Uses your "qa:test" script which targets tests/quality/*
        run: pnpm qa:test

      # Step: install Playwright browsers on the runner
      - name: Install Playwright browsers
        # Playwright CLI command to install browsers and OS dependencies
        run: npx playwright install --with-deps

      # Step: run Playwright tests (API projects)
      - name: Run Playwright API tests
        # Uses your "test" script which runs "playwright test"
        run: pnpm test:api
        env:
          PORT: 3100

      # Step: run Playwright tests (UI projects)
      - name: Run Playwright UI tests
        # Uses your "test" script which runs "playwright test"
        run: pnpm test:ui
        env:
          PORT: 3200

      # Step: upload Playwright HTML report if any previous step failed
      - name: Upload Playwright report on failure
        # Run this step only if the job has failed
        if: failure()
        # Use GitHub's artifact upload action
        uses: actions/upload-artifact@v4
        with:
          # Name for the artifact in GitHub Actions UI
          name: playwright-report
          # Path to the Playwright report folder
          path: playwright-report
          # If report folder is missing, do not fail this step
          if-no-files-found: ignore
          # Keep the artifact for 7 days
          retention-days: 7
