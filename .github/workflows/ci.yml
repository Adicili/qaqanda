# This sets the human-readable name of the workflow in the GitHub Actions UI
name: CI - Build & Test

# This section defines which events will trigger the workflow
on:
  # This event runs the workflow on every pull request
  pull_request:
    # You could restrict branches here if needed (e.g. only PRs into main)
    # branches:
    #   - main

  # This event runs the workflow on direct pushes to branches
  push:
    # Here we limit the push trigger to only the main branch
    branches:
      # Name of the branch for push events
      - main

# This section defines all jobs in this workflow
jobs:
  # First job: responsible for basic build and type validation
  build:
    # Use the Ubuntu Linux runner image
    runs-on: ubuntu-latest

    # Steps executed inside the "build" job
    steps:
      # Step: checkout the repository code to the runner
      - name: Checkout repository
        # Use the official GitHub Action to checkout the code
        uses: actions/checkout@v4

      # Step: configure Node.js runtime
      - name: Setup Node.js
        # Use the official Node setup action
        uses: actions/setup-node@v4
        with:
          # Set Node.js version to 20 (matches your project requirements)
          node-version: 20
          # IMPORTANT: we removed "cache: pnpm" here because pnpm is not installed yet

      # Step: install pnpm on the runner
      - name: Setup pnpm
        # Use the official pnpm setup action
        uses: pnpm/action-setup@v2
        with:
          # Use pnpm version 8 (you can update later if needed)
          version: 8
          # We don't auto-run install here, we keep explicit "pnpm install" below

      # Step: install all project dependencies (node_modules)
      - name: Install dependencies
        # Use pnpm to install dependencies defined in package.json
        run: pnpm install

      # Step: run TypeScript type-check to validate the build
      - name: Type check (build validation)
        # Use tsc in noEmit mode so it only checks types without generating JS
        run: pnpm tsc --noEmit

  # Second job: responsible for linting and running all tests
  test:
    # Declare that the "test" job depends on a successful "build" job
    needs: build
    # Use the same Ubuntu Linux runner for the test job
    runs-on: ubuntu-latest

    # Steps executed inside the "test" job
    steps:
      # Step: checkout the repository again (each job runs in a fresh environment)
      - name: Checkout repository
        # Use the official checkout action
        uses: actions/checkout@v4

      # Step: configure Node.js for the test job
      - name: Setup Node.js
        # Use the same setup-node action
        uses: actions/setup-node@v4
        with:
          # Same Node.js version as in the build job for consistency
          node-version: 20
          # Again, no "cache: pnpm" here, to avoid calling pnpm before it exists

      # Step: install pnpm for the test job
      - name: Setup pnpm
        # Use pnpm setup action again
        uses: pnpm/action-setup@v2
        with:
          # Same pnpm version to keep behavior consistent
          version: 8

      # Step: install project dependencies for the test job
      - name: Install dependencies
        # Run pnpm install again (cache from previous steps may still help on the runner)
        run: pnpm install

      # Step: run ESLint to catch style and code quality issues
      - name: Run ESLint (lint)
        # Run your lint script defined in package.json
        run: pnpm lint

      # Step: run TypeScript type-check in the test job as part of the quality gate
      - name: Run TypeScript type-check
        # Use the same tsc noEmit command
        run: pnpm tsc --noEmit

      # Step: run unit and contract tests (Vitest)
      - name: Run unit tests
        # Use your existing "test:unit" script
        run: pnpm test:unit

      # Step: install Playwright browsers (Chromium/Firefox/WebKit) on the runner
      - name: Install Playwright browsers
        # Use Playwright CLI to download browsers and OS dependencies
        run: npx playwright install --with-deps

      # Step: run Playwright tests (UI + API projects as configured in playwright.config.ts)
      - name: Run Playwright tests
        # Use your "test" script from package.json which maps to "playwright test"
        run: pnpm test

      # Step: upload Playwright HTML report if any previous step in this job failed
      - name: Upload Playwright report on failure
        # This condition ensures the step only runs when the job has failed
        if: failure()
        # Use GitHub's artifact upload action
        uses: actions/upload-artifact@v4
        with:
          # Name displayed for the artifact in the GitHub Actions UI
          name: playwright-report
          # Path to the Playwright report folder generated by the reporter config
          path: playwright-report
          # If the folder is missing, ignore rather than failing this step
          if-no-files-found: ignore
          # Number of days artifacts will be retained and available for download
          retention-days: 7
